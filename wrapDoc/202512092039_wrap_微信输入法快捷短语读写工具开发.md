# 对话总结：微信输入法快捷短语读写工具开发

## 一、主要主题和目标

### 1.1 定位微信输入法快捷短语数据存储位置
- **目标**：找到微信输入法快捷短语（热词）的本地存储文件位置
- **需求**：
  - 确定数据文件的具体路径
  - 了解数据存储格式

### 1.2 实现快捷短语的读写能力
- **目标**：让 AI 能够读取和管理用户的微信输入法快捷短语
- **需求**：
  - 读取现有快捷短语列表
  - 添加新的快捷短语
  - 删除快捷短语
  - 搜索和导出功能

### 1.3 实现自动重启功能
- **目标**：增删改操作后自动重启微信输入法，使修改立即生效
- **需求**：
  - 修改后无需手动操作即可生效

## 二、关键决策和原因

| 决策 | 原因 |
|------|------|
| 使用 MMKV Python 绑定而非直接解析 | MMKV 是腾讯自研的二进制格式，有 CRC 校验，直接修改会损坏数据 |
| 克隆并编译 MMKV 源码而非使用 pip 安装 | pip 上没有现成的 MMKV Python 包，需要从源码编译 |
| 读取使用字符串解析，写入使用 MMKV API | MMKV 的 append-only 特性导致读取复杂，但写入必须通过 API 保证数据完整性 |
| 使用 `killall WeType` 重启输入法 | macOS 系统会自动重启被杀掉的输入法进程，简单可靠 |
| 创建多个工具文件而非单一文件 | `wetype_tool.py` 只读版本，`wetype_rw.py` 尝试版本，`wetype_raw.py` 最终版本，便于迭代 |

## 三、修改/创建的文件列表

### 3.1 核心工具文件

#### `wetype_tool.py`
- **创建内容**：
  - 使用 `strings` 命令提取 MMKV 文件中的 JSON 数据
  - 实现 list、export、search、json 命令
- **原因**：初始版本，仅支持读取，用于验证数据可读性

#### `wetype_rw.py`
- **创建内容**：
  - 尝试使用 MMKV Python API 直接读写
  - 发现 `hotWordList` key 无法通过 API 读取
- **原因**：探索使用官方 API 的可能性，发现读取限制后放弃

#### `wetype_raw.py`
- **创建内容**：
  - 直接解析 MMKV 二进制文件提取 JSON
  - 使用 MMKV API 写入数据
  - 实现 add、delete、list、search、export 功能
  - 添加 `restart_wetype()` 函数自动重启输入法
- **原因**：最终版本，结合两种方法的优势，实现完整功能

### 3.2 依赖和编译文件

#### `MMKV/` 目录
- **创建内容**：
  - 克隆腾讯 MMKV 源码仓库
  - 编译生成 `mmkv.cpython-39-darwin.so` Python 绑定模块
- **原因**：提供 MMKV 的 Python API 支持，用于写入数据

### 3.3 文档和备份文件

#### `README.md`
- **创建内容**：
  - 工具使用说明
  - 技术实现原理
  - 注意事项和故障排除
- **原因**：提供完整的使用文档，便于后续维护和使用

#### `hotwords_backup.json`
- **创建内容**：导出的快捷短语备份文件
- **原因**：数据备份，防止意外丢失

## 四、核心代码片段

### 4.1 重启微信输入法功能
```python
def restart_wetype():
    """重启微信输入法"""
    try:
        result = subprocess.run(
            ["killall", "WeType"],
            capture_output=True,
            text=True,
            timeout=5
        )
        if result.returncode == 0:
            print("🔄 微信输入法已重启")
            time.sleep(1)
            return True
    except Exception as e:
        print(f"⚠️  重启微信输入法时出错: {e}")
        return False
```
**功能**：通过 `killall` 命令杀掉微信输入法进程，macOS 会自动重启  
**原因**：确保修改后的数据立即生效，无需用户手动操作

### 4.2 添加快捷短语功能
```python
def add_hotword(trigger_key, text):
    import mmkv
    hotwords = read_raw_hotwords()
    new_id = str(int(time.time() * 1000))
    new_hotword = {"hw_id": new_id, "key": trigger_key, "text": text}
    hotwords.insert(0, new_hotword)
    mmkv.MMKV.initializeMMKV(WETYPE_MMKV_DIR)
    kv = mmkv.MMKV("wetype.settings")
    hotwords_json = json.dumps(hotwords, ensure_ascii=False)
    kv.set(hotwords_json, "hotWordList")
    restart_wetype()
```
**功能**：读取现有热词，添加新项，写入 MMKV，自动重启  
**原因**：保证数据完整性，使用时间戳生成唯一 ID，自动重启确保生效

### 4.3 从二进制文件读取热词
```python
def read_raw_hotwords():
    with open(WETYPE_SETTINGS_FILE, 'rb') as f:
        data = f.read()
    text = data.decode('utf-8', errors='ignore')
    hotword_positions = [m.start() for m in re.finditer(r'hotWordList', text)]
    # 解析 JSON 数组...
    return max(all_hotwords, key=len)
```
**功能**：直接从二进制文件查找 `hotWordList` 后的 JSON 数组  
**原因**：MMKV API 无法读取该 key，但数据确实存在文件中，通过字符串解析可以提取

## 五、解决的问题

### 5.1 MMKV 格式无法直接读写
- **问题**：微信输入法使用 MMKV 二进制格式，Python 没有现成的库
- **解决方案**：
  1. 克隆 MMKV 源码
  2. 安装 CMake 编译工具
  3. 编译生成 Python 绑定模块
  4. 使用编译好的 `.so` 文件
- **结果**：成功编译并导入 MMKV 模块

### 5.2 MMKV API 无法读取 hotWordList
- **问题**：通过 MMKV API 的 `getString("hotWordList")` 返回空值
- **解决方案**：直接解析二进制文件，查找 `hotWordList` 字符串后的 JSON 数据
- **结果**：成功读取到 85 条快捷短语

### 5.3 修改后需要手动重启输入法
- **问题**：用户反馈修改后在界面看不到，需要手动重启
- **解决方案**：添加 `restart_wetype()` 函数，增删改操作后自动调用 `killall WeType`
- **结果**：修改后自动重启，立即生效

### 5.4 pip 安装 MMKV 失败
- **问题**：`pip install mmkv` 找不到包
- **解决方案**：从源码编译，使用 CMake 构建系统
- **结果**：成功编译并集成到工具中

## 六、未解决的问题/待办事项

1. **MMKV 读取方式不够优雅**：目前通过字符串解析读取，如果格式变化可能失效。理想方案是完全使用 MMKV API，但需要进一步研究为什么 API 读不到 `hotWordList`
2. **批量导入功能**：目前只能逐个添加，可以考虑添加批量导入 JSON 文件的功能
3. **编辑功能**：目前只能添加和删除，无法直接修改已有快捷短语的内容

## 七、技术细节和注意事项

### 7.1 数据文件位置
- **路径**：`~/Library/Application Support/WeType/mmkv/wetype.settings`
- **格式**：MMKV 二进制格式，有对应的 `.crc` 校验文件
- **注意事项**：不要直接修改二进制文件，必须通过 MMKV API 写入

### 7.2 MMKV Python 模块路径
- **位置**：`MMKV/Python/build/mmkv.cpython-39-darwin.so`
- **加载方式**：通过 `sys.path.insert(0, MMKV_BUILD_DIR)` 动态添加路径
- **注意事项**：Python 版本必须匹配（当前为 3.9）

### 7.3 重启机制
- **方法**：`killall WeType`
- **原理**：macOS 会自动重启被杀掉的输入法进程
- **注意事项**：如果进程不存在（返回非0），也算成功

### 7.4 热词数据结构
```json
{
  "hw_id": "时间戳",
  "key": "触发词",
  "text": "展开内容"
}
```

## 八、达成的共识和方向

1. **工具定位**：作为 AI 辅助工具，让 AI 能够管理用户的快捷短语，提高工作效率
2. **实现策略**：读取用字符串解析（实用），写入用 MMKV API（安全）
3. **用户体验**：所有修改操作自动重启输入法，无需手动操作
4. **数据安全**：写入前备份，使用 MMKV API 保证数据完整性

## 九、文件清单

**新建的文件（6个）：**
- `wetype_tool.py` - 初始只读工具
- `wetype_rw.py` - API 尝试版本
- `wetype_raw.py` - 最终完整版本
- `README.md` - 使用文档
- `hotwords_backup.json` - 数据备份
- `MMKV/` - 源码和编译产物目录

**修改的文件（2个）：**
- `wetype_raw.py` - 添加重启功能
- `README.md` - 更新使用说明

**总计：8 个文件**

## 十、当前状态

✅ **已完成**：
- 定位微信输入法数据存储位置
- 编译 MMKV Python 绑定
- 实现快捷短语的读取功能（85 条）
- 实现快捷短语的添加功能
- 实现快捷短语的删除功能
- 实现搜索和导出功能
- 实现自动重启微信输入法功能
- 完成功能测试验证

✅ **运行状态**：
- 工具可正常使用：`python3 wetype_raw.py list/add/delete/search`
- MMKV 模块编译成功并可用
- 自动重启功能正常工作
- 已添加测试快捷短语："测试" → "这是一个测试快捷短语，用于验证功能是否正常"

✅ **下一步计划**：
- 用户可以在微信输入法界面验证新添加的快捷短语
- 如需批量管理，可以考虑添加批量导入功能

---
**文档创建时间**：2025-12-09 20:39  
**对话时长**：约 1 小时  
**主要成果**：完成微信输入法快捷短语的完整读写工具，支持自动重启






